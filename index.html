<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KEYCEE ELITE v26.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .jt-red { background-color: #dc2626; }
        .active-tab { border-bottom: 4px solid #dc2626; color: #dc2626; font-weight: 900; }
        .bg-green-paid { background-color: #dcfce7 !important; border-color: #22c55e !important; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gray-100 pb-64 font-sans text-gray-900">

    <nav class="jt-red p-4 text-white sticky top-0 z-50 flex justify-between items-center shadow-lg">
        <div>
            <h1 class="font-black italic text-lg tracking-tighter uppercase">KEYCEE v26.0</h1>
            <p id="activeDriverDisplay" class="text-[10px] font-bold opacity-80 uppercase">Driver: Admin</p>
        </div>
        <div class="flex gap-2">
            <button onclick="openExpense()" class="bg-white/20 p-2 rounded-lg text-[9px] font-black uppercase">üí∏ EXPENSES</button>
            <button onclick="openAdmin()" class="bg-black/30 p-2 rounded-lg text-[9px] font-black uppercase border border-white/20">‚öôÔ∏è ADMIN</button>
        </div>
    </nav>

    <div class="flex bg-white sticky top-[60px] z-40 border-b overflow-x-auto scrollbar-hide shadow-sm">
        <button onclick="showTab('delivery')" id="t1" class="flex-1 py-4 text-[10px] uppercase active-tab whitespace-nowrap px-6">üöö Route</button>
        <button onclick="showTab('utang')" id="t2" class="flex-1 py-4 text-[10px] uppercase font-black text-red-600 whitespace-nowrap px-6">üî¥ Utang Tab</button>
        <button onclick="showTab('directory')" id="t3" class="flex-1 py-4 text-[10px] uppercase whitespace-nowrap px-6">üë• Suki List</button>
        <button onclick="showTab('logs')" id="t4" class="flex-1 py-4 text-[10px] uppercase whitespace-nowrap px-6">üõ°Ô∏è Logs</button>
    </div>

    <div class="p-4 space-y-4">
        <button onclick="copyMessengerReport()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black text-xs uppercase shadow-md active:scale-95 transition">
            üìã Copy Messenger Report
        </button>

        <div class="flex gap-2">
            <input type="text" id="mainSearch" onkeyup="render()" placeholder="Search Area, Name, Landmark..." class="flex-1 p-4 rounded-2xl shadow-sm text-sm font-bold border-none outline-none">
            <select id="driverSelect" onchange="changeDriver()" class="bg-white px-3 rounded-2xl text-[10px] font-black uppercase shadow-sm border-none outline-none"></select>
        </div>

        <div id="tab-delivery" class="space-y-4">
            <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-red-50">
                <div class="grid grid-cols-2 gap-2">
                    <input list="masterNames" id="addName" oninput="autofill()" placeholder="Customer Name" class="col-span-2 p-3 rounded-xl border bg-gray-50 font-black uppercase text-sm outline-none">
                    <datalist id="masterNames"></datalist>
                    <input type="number" id="addAmt" placeholder="Order Price" class="p-3 rounded-xl border bg-gray-50 font-black text-red-600 outline-none">
                    <input type="text" id="addPhone" placeholder="Phone Number" class="p-3 rounded-xl border bg-gray-50 font-bold outline-none">
                    <input type="text" id="addArea" placeholder="Area / Barangay" class="p-3 rounded-xl border bg-gray-50 font-black uppercase outline-none">
                    <input type="text" id="addLandmark" placeholder="Landmark" class="p-3 rounded-xl border bg-gray-50 font-bold outline-none">
                    <div id="debtHint" class="hidden col-span-2 p-3 bg-red-50 rounded-xl text-[10px] font-black text-red-600 uppercase border border-red-100 italic">
                        ‚ö†Ô∏è EXISTING BALANCE: ‚Ç±<span id="hintAmt">0</span>
                    </div>
                    <button onclick="addOrder()" class="col-span-2 jt-red text-white py-4 rounded-xl font-black text-xs uppercase shadow-lg active:opacity-80">Add to Daily Route</button>
                </div>
            </div>
            
            <div id="areaStats" class="hidden bg-gray-800 text-white p-3 rounded-xl flex justify-between px-6 text-[10px] font-black uppercase shadow-inner">
                <span>Smart Search Sales:</span> <span id="areaSalesVal" class="text-yellow-400 font-black">‚Ç±0</span>
            </div>
            <div id="list-delivery" class="space-y-3"></div>
        </div>

        <div id="tab-utang" class="hidden space-y-3">
            <div class="bg-red-600 p-6 rounded-[2rem] text-white shadow-lg text-center">
                <p class="text-[10px] font-black uppercase opacity-70 mb-1 tracking-widest">Total Suki Debt</p>
                <h2 id="totalUtangDisplay" class="text-4xl font-black italic">‚Ç±0</h2>
            </div>
            <div id="list-utang" class="space-y-2"></div>
        </div>

        <div id="tab-directory" class="hidden space-y-2">
            <div class="flex justify-between items-center p-2 text-[10px] font-black text-gray-400 uppercase">
                <span>Suki Loyalty Program</span>
                <button onclick="showHeatmap()" class="text-red-600 underline">Area Heatmap</button>
            </div>
            <div id="list-directory" class="space-y-2"></div>
        </div>

        <div id="tab-logs" class="hidden space-y-2">
            <div id="list-logs" class="space-y-1"></div>
        </div>
    </div>

    <div id="updateModal" class="hidden fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-6 shadow-2xl relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeUpdate()" class="absolute top-4 right-4 text-gray-300 font-bold p-2">‚úï</button>
            <h2 id="upTitle" class="font-black text-red-600 text-lg uppercase italic mb-4">Update Order</h2>
            <div class="bg-gray-900 p-4 rounded-2xl mb-4 text-center shadow-inner">
                <p class="text-[10px] font-black text-gray-500 uppercase tracking-tighter">Total Due (New + Old)</p>
                <p id="upNetTotal" class="text-3xl font-black text-yellow-400">‚Ç±0</p>
                <p id="upBreakdown" class="text-[9px] text-gray-400 font-bold mt-1 uppercase"></p>
            </div>
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <input type="number" id="upCash" onkeyup="calcUp()" placeholder="Cash Paid" class="p-3 rounded-xl border font-black text-green-600 bg-green-50 outline-none">
                    <input type="number" id="upGcash" onkeyup="calcUp()" placeholder="GCash" class="p-3 rounded-xl border font-black text-blue-600 bg-blue-50 outline-none">
                    <input type="number" id="upRet" onkeyup="calcUp()" placeholder="Return/RTS" class="p-3 rounded-xl border font-black text-red-600 bg-red-50 outline-none">
                    <input type="number" id="upBal" readonly placeholder="Balance" class="p-3 rounded-xl border bg-gray-100 font-black outline-none">
                </div>
                <select id="switchDriver" onchange="realtimeDriverChange()" class="w-full bg-gray-50 p-3 rounded-xl text-xs font-black border uppercase outline-none"></select>
                <textarea id="upReason" placeholder="REASON FOR EDIT/DELETE (REQUIRED)" class="w-full p-3 rounded-xl border border-red-100 text-[10px] font-bold h-16 outline-none"></textarea>
                <div class="flex gap-2 pt-2">
                    <button onclick="deleteOrder()" class="bg-red-50 text-red-600 px-4 rounded-xl text-[10px] font-black uppercase">Delete</button>
                    <button onclick="saveUpdate()" class="flex-1 jt-red text-white py-4 rounded-xl font-black text-xs uppercase shadow-lg">Save Transaction</button>
                </div>
            </div>
        </div>
    </div>

    <div id="adminModal" class="hidden fixed inset-0 bg-black/95 z-[110] p-6 flex items-center justify-center">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 space-y-4 relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeAdmin()" class="absolute top-4 right-6 text-gray-300 font-bold p-2">‚úï</button>
            <h2 class="font-black text-red-600 text-xl text-center uppercase italic tracking-tighter">Admin Control Center</h2>
            
            <div class="bg-gray-100 rounded-2xl p-4">
                <div class="flex justify-between text-[10px] font-black uppercase mb-1"><span>Internal Storage (Local)</span><span id="storageTxt">0%</span></div>
                <div class="w-full bg-gray-300 h-2 rounded-full overflow-hidden"><div id="storageBar" class="jt-red h-full" style="width: 0%"></div></div>
            </div>

            <div class="p-4 bg-red-50 rounded-2xl border border-red-100">
                <input type="password" id="newPinInput" placeholder="Set New Admin PIN" class="w-full p-3 border rounded-xl text-center font-black mb-2 shadow-inner outline-none">
                <button onclick="changePin()" class="w-full bg-black text-white py-3 rounded-xl text-[10px] font-black uppercase">Change Security PIN</button>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <button onclick="exportData('master')" class="bg-blue-600 text-white p-3 rounded-xl text-[9px] font-black uppercase">Export Suki List</button>
                <label class="bg-blue-50 text-blue-600 p-3 rounded-xl text-[9px] font-black uppercase text-center cursor-pointer">Import Suki List <input type="file" class="hidden" onchange="importData(event, 'master')"></label>
                <button onclick="exportData('daily')" class="bg-green-600 text-white p-3 rounded-xl text-[9px] font-black uppercase">Export Route</button>
                <label class="bg-green-50 text-green-700 p-3 rounded-xl text-[9px] font-black uppercase text-center cursor-pointer">Sync Driver File <input type="file" class="hidden" onchange="importData(event, 'daily')"></label>
            </div>

            <div class="p-4 bg-gray-50 rounded-2xl">
                <p class="text-[10px] font-black text-gray-400 mb-2 uppercase text-center">Approved Drivers</p>
                <div id="adminDriverList" class="space-y-1 mb-2"></div>
                <button onclick="addDriverAdmin()" class="w-full bg-white border-2 border-dashed py-3 rounded-xl text-[10px] font-black uppercase">+ Register Driver</button>
            </div>

            <button onclick="manualArchive()" class="w-full bg-red-600 text-white py-5 rounded-2xl font-black text-xs uppercase shadow-xl">üóÇÔ∏è Manual Archive (Excel Export)</button>
            <button onclick="forceClearLogs()" class="w-full text-gray-300 py-2 text-[8px] font-black uppercase text-center">Force Clear History Logs</button>
        </div>
    </div>

    <footer class="fixed bottom-0 left-0 w-full bg-white border-t z-50">
        <div class="grid grid-cols-3 gap-1 p-3 bg-gray-50 border-b">
            <a href="https://facebook.com" class="flex flex-col items-center"><img src="https://img.icons8.com/color/48/facebook-new.png" class="w-6 h-6"><span class="text-[8px] font-black uppercase">FB Page</span></a>
            <a href="https://m.me/" class="flex flex-col items-center"><img src="https://img.icons8.com/color/48/messenger.png" class="w-6 h-6"><span class="text-[8px] font-black uppercase">Messenger</span></a>
            <a href="https://business.facebook.com" class="flex flex-col items-center"><img src="https://img.icons8.com/color/48/meta.png" class="w-6 h-6"><span class="text-[8px] font-black uppercase">Meta Suite</span></a>
        </div>
   
    </footer>

    <script>
        const PRE = 'KC26_';
        let db = JSON.parse(localStorage.getItem(PRE+'db')) || [];
        let master = JSON.parse(localStorage.getItem(PRE+'master')) || [];
        let expenses = JSON.parse(localStorage.getItem(PRE+'exp')) || [];
        let logs = JSON.parse(localStorage.getItem(PRE+'logs')) || [];
        let drivers = JSON.parse(localStorage.getItem(PRE+'drivers')) || ["Admin"];
        let activeDriver = localStorage.getItem(PRE+'activeDriver') || "Admin";
        let settings = JSON.parse(localStorage.getItem(PRE+'set')) || { pin: "1234" };

        let upId = null;
        let sessionDel = [];
        let sessionEdit = [];

        function save() {
            localStorage.setItem(PRE+'db', JSON.stringify(db));
            localStorage.setItem(PRE+'master', JSON.stringify(master));
            localStorage.setItem(PRE+'exp', JSON.stringify(expenses));
            localStorage.setItem(PRE+'logs', JSON.stringify(logs));
            localStorage.setItem(PRE+'drivers', JSON.stringify(drivers));
            localStorage.setItem(PRE+'activeDriver', activeDriver);
            localStorage.setItem(PRE+'set', JSON.stringify(settings));
            updateStorageUI();
        }

        // --- MERGE LOGIC ---
        function autofill() {
            const name = document.getElementById('addName').value.toUpperCase().trim();
            const m = master.find(x => x.name === name);
            const hint = document.getElementById('debtHint');
            if(m) {
                document.getElementById('addPhone').value = m.phone || "";
                document.getElementById('addArea').value = m.area || "";
                document.getElementById('addLandmark').value = m.landmark || "";
                const d = (m.debts || []).reduce((s,x)=>s+x.amount,0);
                if(d > 0) { hint.classList.remove('hidden'); document.getElementById('hintAmt').innerText = d; }
                else hint.classList.add('hidden');
            } else hint.classList.add('hidden');
        }

        function addOrder() {
            const name = document.getElementById('addName').value.toUpperCase().trim();
            const amt = parseFloat(document.getElementById('addAmt').value);
            const phone = document.getElementById('addPhone').value;
            const area = document.getElementById('addArea').value.toUpperCase().trim();
            const landmark = document.getElementById('addLandmark').value;

            if(!name || isNaN(amt)) return alert("Required: Name & Price");

            let mIdx = master.findIndex(x => x.name === name);
            let oldDebt = 0;
            if(mIdx === -1) {
                master.push({ name, phone, area, landmark, count:0, totalSpent:0, debts:[], lastOrderTs: Date.now() });
            } else {
                oldDebt = (master[mIdx].debts || []).reduce((s,x)=>s+x.amount,0);
            }

            let existing = db.find(o => o.name === name && !o.isDelivered);
            if(existing) {
                existing.items.push({ amt, date: new Date().toLocaleDateString() });
                existing.itemPrice += amt;
                existing.totalDue += amt;
                addLog(`MERGE: ‚Ç±${amt} added to ${name}`);
            } else {
                db.push({
                    id: Date.now(), uid: phone + "_" + Date.now(),
                    name, phone, area, landmark,
                    items: [{ amt, date: new Date().toLocaleDateString() }],
                    itemPrice: amt, oldDebtRef: oldDebt, totalDue: amt + oldDebt,
                    cash:0, gcash:0, rts:0, isDelivered: false,
                    driver: activeDriver, date: new Date().toLocaleDateString()
                });
                addLog(`ADD: ${name} (New:‚Ç±${amt} + Old:‚Ç±${oldDebt})`);
            }
            save(); render();
            ['addName','addAmt','addPhone','addArea','addLandmark'].forEach(i=>document.getElementById(i).value="");
            document.getElementById('debtHint').classList.add('hidden');
        }

        // --- PAYMENT & UPDATE ---
        function openUpdate(id) {
            upId = id; const i = db.find(x=>x.id===id);
            document.getElementById('upTitle').innerText = i.name;
            document.getElementById('upNetTotal').innerText = "‚Ç±" + i.totalDue;
            document.getElementById('upBreakdown').innerText = i.items.map(x=>x.amt).join(' + ') + ` | Old Bal: ‚Ç±${i.oldDebtRef}`;
            document.getElementById('upCash').value = i.cash || "";
            document.getElementById('upGcash').value = i.gcash || "";
            document.getElementById('upRet').value = i.rts || "";
            document.getElementById('switchDriver').value = i.driver;
            document.getElementById('upReason').value = "";
            calcUp(); document.getElementById('updateModal').classList.remove('hidden');
        }

        function calcUp() {
            const i = db.find(x=>x.id===upId);
            const c = parseFloat(document.getElementById('upCash').value)||0;
            const g = parseFloat(document.getElementById('upGcash').value)||0;
            const r = parseFloat(document.getElementById('upRet').value)||0;
            const b = i.totalDue - (c+g+r);
            document.getElementById('upBal').value = b < 0 ? 0 : b;
        }

        function saveUpdate() {
            const i = db.find(x=>x.id===upId);
            const c = parseFloat(document.getElementById('upCash').value)||0;
            const g = parseFloat(document.getElementById('upGcash').value)||0;
            const r = parseFloat(document.getElementById('upRet').value)||0;
            const reason = document.getElementById('upReason').value.trim();

            if((i.cash!==c || i.gcash!==g || i.rts!==r) && !reason) return alert("Reason required for changes!");

            const mIdx = master.findIndex(m=>m.name===i.name);
            if(mIdx > -1) {
                if(!i.isDelivered) { master[mIdx].count++; master[mIdx].totalSpent += (c+g); master[mIdx].lastOrderTs = Date.now(); }
                // Clear old debts only if full payment is reached
                if((c + g + r) >= i.totalDue) master[mIdx].debts = [];
            }

            if(reason) {
                sessionEdit.push(`${i.name}: ‚Ç±${i.totalDue} ‚û°Ô∏è Paid ‚Ç±${c+g} [${reason}]`);
                addLog(`EDIT: ${i.name} [${reason}]`, 'edit');
            }
            i.cash=c; i.gcash=g; i.rts=r; i.isDelivered=(c+g+r > 0);
            save(); render(); closeUpdate();
        }

        // --- PARTIAL PAYMENT SYNC ---
        function partialPay(name) {
            const m = master.find(x=>x.name===name);
            const totalDebt = (m.debts || []).reduce((s,x)=>s+x.amount,0);
            const pay = parseFloat(prompt(`Total Debt: ‚Ç±${totalDebt}\nEnter amount to pay:`));
            
            if(!isNaN(pay) && pay > 0) {
                const change = pay - totalDebt;
                if(change >= 0) {
                    m.debts = [];
                    alert("Debt fully cleared!");
                } else {
                    // Reduce from existing debts (Logic: Deduct from oldest first)
                    let remainingToDeduct = pay;
                    m.debts.sort((a,b)=>new Date(a.date)-new Date(b.date));
                    for(let d of m.debts) {
                        if(remainingToDeduct <= 0) break;
                        if(remainingToDeduct >= d.amount) {
                            remainingToDeduct -= d.amount;
                            d.amount = 0;
                        } else {
                            d.amount -= remainingToDeduct;
                            remainingToDeduct = 0;
                        }
                    }
                    m.debts = m.debts.filter(d => d.amount > 0);
                }

                // SYNC TO ROUTE: Update card if it exists today
                db.forEach(o => {
                    if(o.name === name) {
                        o.cash += pay;
                        o.isDelivered = true;
                    }
                });

                addLog(`PAYMENT: ${name} paid ‚Ç±${pay} partial.`);
                save(); render();
            }
        }

        // --- RENDER ---
        function render() {
            const q = document.getElementById('mainSearch').value.toUpperCase();
            const listDel = document.getElementById('list-delivery');
            const listUtang = document.getElementById('list-utang');
            const listDir = document.getElementById('list-directory');
            const listLogs = document.getElementById('list-logs');

            listDel.innerHTML = ""; listUtang.innerHTML = ""; listDir.innerHTML = ""; listLogs.innerHTML = "";

            let searchSales = 0;
            db.forEach(i => {
                if(i.name.includes(q) || i.area.includes(q)) {
                    if(q.length > 2 && i.area.includes(q) && i.isDelivered) searchSales += (i.cash + i.gcash);
                    const m = master.find(x=>x.name===i.name);
                    const bal = i.totalDue - (i.cash + i.gcash + i.rts);
                    const loyalty = getLoyalty(m);

                    listDel.innerHTML += `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 ${i.isDelivered ? (bal <=0 ? 'bg-green-paid' : 'border-orange-400') : 'border-gray-200'}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-black text-xs uppercase">${i.name} ${loyalty.includes('‚≠ê')?'<span class="text-yellow-500">‚≠ê</span>':''}</h4>
                                <p class="text-[9px] font-bold text-blue-600">üìç ${i.area} | ${i.landmark}</p>
                                <p class="text-[8px] text-gray-400 font-bold uppercase mt-1">DRIVER: ${i.driver}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[8px] font-black text-gray-300 uppercase leading-none">${i.items.map(x=>x.amt).join('+')}</p>
                                <p class="font-black text-red-600 text-sm">‚Ç±${i.itemPrice}</p>
                                ${bal > 0 && i.isDelivered ? `<p class="text-[8px] font-black text-red-600">UTANG: ‚Ç±${bal}</p>` : ''}
                            </div>
                        </div>
                        <div class="flex gap-2 mt-3">
                            <button onclick="openUpdate(${i.id})" class="flex-1 bg-white border py-3 rounded-xl text-[9px] font-black uppercase shadow-sm">Update Payment</button>
                            <a href="sms:${i.phone}?body=${encodeURIComponent('Good day po Keycee prelove salamat po sa pag order total Delivery P.'+i.totalDue+' salamat po')}" class="bg-blue-50 text-blue-600 px-4 py-3 rounded-xl text-[9px] font-black uppercase font-bold">SMS</a>
                        </div>
                    </div>`;
                }
            });

            // UTANG LIST
            let grandUtang = 0;
            master.forEach(m => {
                const old = (m.debts || []);
                const nw = db.filter(d=>d.name===m.name && d.isDelivered && (d.totalDue-(d.cash+d.gcash+d.rts))>0);
                const pO = old.reduce((s,x)=>s+x.amount,0);
                const pN = nw.reduce((s,x)=>s+(x.totalDue-(x.cash+x.gcash+x.rts)),0);
                grandUtang += (pO + pN);
                if(pO + pN > 0 && m.name.includes(q)) {
                    listUtang.innerHTML += `
                    <div class="bg-white p-4 rounded-2xl border-r-4 border-red-500 shadow-sm flex justify-between items-center">
                        <div><p class="font-black text-xs uppercase">${m.name}</p><p class="text-[9px] text-gray-400">Balance: ‚Ç±${pO+pN}</p></div>
                        <button onclick="partialPay('${m.name}')" class="bg-red-50 text-red-600 px-4 py-2 rounded-xl text-[9px] font-black uppercase">Pay Balance</button>
                    </div>`;
                }
            });
            document.getElementById('totalUtangDisplay').innerText = "‚Ç±" + grandUtang;

            // DIRECTORY
            master.filter(m=>m.name.includes(q)).forEach(m => {
                listDir.innerHTML += `<div class="bg-white p-4 rounded-xl flex justify-between shadow-sm items-center"><div><p class="font-black text-xs uppercase">${m.name} ${getLoyalty(m).includes('‚≠ê')?'‚≠ê':''}</p><p class="text-[9px] text-gray-400 uppercase">Success Orders: ${m.count} | Total: ‚Ç±${m.totalSpent}</p></div><button onclick="delSuki('${m.name}')" class="text-gray-200">üóë</button></div>`;
            });

            // LOGS
            listLogs.innerHTML = logs.map(l=>`<div class="bg-white p-2 border-l-2 ${l.type==='del'?'border-red-500':'border-gray-300'} text-[9px] uppercase"><span class="font-black opacity-30">${l.driver} ‚Ä¢ ${l.time}</span><p class="font-bold">${l.msg}</p></div>`).join('');

            if(q.length > 2) { document.getElementById('areaStats').classList.remove('hidden'); document.getElementById('areaSalesVal').innerText = "‚Ç±" + searchSales; }
            else document.getElementById('areaStats').classList.add('hidden');
            
            document.getElementById('masterNames').innerHTML = master.map(m=>`<option value="${m.name}">`).join('');
            document.getElementById('driverSelect').innerHTML = drivers.map(d=>`<option value="${d}" ${d===activeDriver?'selected':''}>${d}</option>`).join('');
            document.getElementById('switchDriver').innerHTML = document.getElementById('driverSelect').innerHTML;
            document.getElementById('activeDriverDisplay').innerText = "Driver: " + activeDriver;
        }

        // --- EXPORTS & SYNC ---
        function exportData(type) {
            const data = type === 'master' ? master : db;
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = `KC_${type}_${Date.now()}.json`;
            a.click();
        }

        function importData(e, type) {
            const reader = new FileReader(); reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if(type === 'master') {
                        data.forEach(n => {
                            let mI = master.findIndex(m => m.phone === n.phone);
                            if(mI === -1) master.push(n); else master[mI] = {...master[mI], ...n};
                        });
                    } else {
                        data.forEach(n => {
                            let dI = db.findIndex(o => o.uid === n.uid);
                            if(dI === -1) db.push(n); else if(n.isDelivered) db[dI] = n;
                        });
                    }
                    save(); render(); alert("Sync Successful!");
                } catch(err) { alert("Import Error!"); }
            }; reader.readAsText(e.target.files[0]);
        }

        // --- MESSENGER REPORT ---
        function copyMessengerReport() {
            const date = new Date().toLocaleDateString();
            const cod = db.reduce((s,i)=>s+i.cash,0); const gcash = db.reduce((s,i)=>s+i.gcash,0); const exp = expenses.reduce((s,i)=>s+i.amount,0);
            const deliv = db.filter(i=>i.isDelivered);
            let uL = ""; let uT = 0;
            master.forEach(m=>{
                const old = m.debts || []; const nw = db.filter(d=>d.name===m.name && d.isDelivered && (d.totalDue-(d.cash+d.gcash+d.rts))>0);
                const pO = old.reduce((s,x)=>s+x.amount,0); const pN = nw.reduce((s,x)=>s+(x.totalDue-(x.cash+x.gcash+x.rts)),0);
                if(pO+pN>0){ uT+=(pO+pN); uL+=`${m.name}: OLD[${old.map(x=>x.date).join(',')}] ‚Ç±${pO} + NEW ‚Ç±${pN} = ‚Ç±${pO+pN}\n`; }
            });
            let r = `[${date}]\nDelivered today\n`;
            deliv.forEach(i=>r+=`${i.name}: ‚Ç±${i.cash+i.gcash} [ORDER:${i.date}]\n`);
            r+=`Prospect Delivery: ‚Ç±${db.reduce((s,i)=>s+i.itemPrice,0)}\n-----------------\nTotal cash to remit: ‚Ç±${cod+gcash-exp}\nCod total: ‚Ç±${cod}\nTotal expences: ‚Ç±${exp}\nDelivered Customers: ${deliv.length}\nUndelivered: ${db.length-deliv.length}\n----------\nGcash List:\n`;
            db.filter(i=>i.gcash>0).forEach(i=>r+=`${i.name}: ‚Ç±${i.gcash}\n`);
            r+=`Gcash total: ‚Ç±${gcash}\n----------\nUtang whole total: ‚Ç±${uT}\nUtang list:\n${uL}\n------------- \nLIST OF DELETED:\n${sessionDel.join('\n')}\n-------------\nLIST OF EDITED:\n${sessionEdit.join('\n')}`;
            const el = document.createElement('textarea'); el.value = r; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
            alert("Report Copied for Messenger!");
        }

        function manualArchive() {
            if(prompt("Admin PIN:") !== settings.pin) return alert("Unauthorized");
            // Download Excel Like Form
            let h = `<html><head><meta charset="utf-8"></head><body><h2>KEYCEE ARCHIVE ${new Date().toLocaleDateString()}</h2><table border="1"><tr><th>Customer</th><th>Paid</th><th>Utang</th><th>Driver</th></tr>`;
            db.filter(i=>i.isDelivered).forEach(i=>{ 
                const bal = i.totalDue-(i.cash+i.gcash+i.rts);
                h+=`<tr><td>${i.name}</td><td>${i.cash+i.gcash}</td><td>${bal}</td><td>${i.driver}</td></tr>`;
                // Move to permanent debt if unpaid
                if(bal > 0) {
                    const mI = master.findIndex(m=>m.name===i.name);
                    if(mI>-1) { if(!master[mI].debts) master[mI].debts=[]; master[mI].debts.push({date:i.date, amount:bal}); }
                }
            });
            h += `</table></body></html>`;
            const blob = new Blob([h], {type: "application/vnd.ms-excel"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Archive_${Date.now()}.xls`; a.click();
            
            db = db.filter(i=>!i.isDelivered); expenses = []; sessionDel=[]; sessionEdit=[];
            save(); render(); closeAdmin();
        }

        // --- HELPERS ---
        function getLoyalty(m) { if(!m) return ""; if((Date.now() - m.lastOrderTs) > (30*24*60*60*1000)) return ""; return m.count >= 10 ? "‚≠ê" : ""; }
        function addLog(msg, type='info') {
            const limit = 30 * 24 * 60 * 60 * 1000;
            if(logs.some(l=>(Date.now()-l.ts)>limit)) { manualArchive(); logs = logs.filter(l=>(Date.now()-l.ts)<limit); }
            logs.unshift({ driver: activeDriver, msg, time: new Date().toLocaleTimeString(), ts: Date.now(), type });
            save();
        }
        function openAdmin() { if(prompt("Admin PIN:")===settings.pin) { document.getElementById('adminModal').classList.remove('hidden'); renderAdmin(); } }
        function closeAdmin() { document.getElementById('adminModal').classList.add('hidden'); }
        function closeUpdate() { document.getElementById('updateModal').classList.add('hidden'); }
        function showTab(t) {
            document.querySelectorAll('[id^="tab-"]').forEach(el=>el.classList.add('hidden'));
            document.querySelectorAll('[id^="t"]').forEach(el=>el.classList.remove('active-tab'));
            document.getElementById('tab-'+t).classList.remove('hidden');
            document.getElementById({'delivery':'t1','utang':'t2','directory':'t3','logs':'t4'}[t]).classList.add('active-tab');
            render();
        }
        function updateStorageUI() { const p = Math.min(100, Math.round((JSON.stringify(localStorage).length/5000000)*100)); document.getElementById('storageBar').style.width = p+"%"; document.getElementById('storageTxt').innerText = p+"%"; }
        function changePin() { const p = document.getElementById('newPinInput').value; if(p.length>3){ settings.pin=p; save(); alert("PIN Updated!"); }}
        function changeDriver() { activeDriver = document.getElementById('driverSelect').value; save(); render(); }
        function openExpense() { const n = prompt("Expense (Gas/Food):"); const a = parseFloat(prompt("Amount:")); if(n && !isNaN(a)){ expenses.push({note:n, amount:a, driver:activeDriver}); save(); render(); }}
        function delDriver(n) { if(drivers.length>1){ drivers=drivers.filter(x=>x!==n); save(); renderAdmin(); }}
        function addDriverAdmin() { const n = prompt("New Driver Name:"); if(n){ drivers.push(n.toUpperCase()); save(); renderAdmin(); }}
        function renderAdmin() { document.getElementById('adminDriverList').innerHTML = drivers.map(d=>`<div class="p-2 border rounded mb-1 flex justify-between uppercase text-[10px] font-black"><span>${d}</span> <button onclick="delDriver('${d}')" class="text-red-500">üóë</button></div>`).join(''); }
        function deleteOrder() { const r = document.getElementById('upReason').value.trim(); if(!r) return alert("Reason required!"); const i = db.find(x=>x.id===upId); sessionDel.push(`${i.name}: ‚Ç±${i.itemPrice} [${r}]`); addLog(`DEL: ${i.name} [${r}]`, 'del'); db = db.filter(x=>x.id!==upId); save(); render(); closeUpdate(); }
        function realtimeDriverChange() { const i = db.find(x=>x.id===upId); i.driver = document.getElementById('switchDriver').value; save(); }
        function delSuki(n) { if(confirm("Remove Suki?")){ master=master.filter(x=>x.name!==n); save(); render(); }}
        function showHeatmap() { const c = {}; master.forEach(m=>c[m.area]=(c[m.area]||0)+1); const s = Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,5); alert("üî• TOP AREAS:\n"+s.map(x=>`${x[0]}: ${x[1]} Sukis`).join('\n')); }
        function forceClearLogs() { if(confirm("Clear logs?")){ logs=[]; save(); render(); }}

        render();

// Force Install Prompt
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        const blob = new Blob([`
            self.addEventListener('fetch', (e) => {
                e.respondWith(fetch(e.request).catch(() => caches.match(e.request)));
            });
        `], { type: 'text/javascript' });
        const url = URL.createObjectURL(blob);
        navigator.serviceWorker.register(url);
    });
}

    </script>
</body>
</html>
